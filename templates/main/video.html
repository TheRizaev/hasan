{% extends 'main/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ video.title }} - KRONIK{% endblock %}

{% block content %}
<div class="video-page-layout">
    <div class="video-content">
        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã AJAX-–∑–∞–ø—Ä–æ—Å–æ–≤ -->
        {% csrf_token %}
        <div class="video-container" data-video-id="{{ video.gcs_id }}" data-user-id="{{ video.user_id }}">
            <div class="video-wrapper">
                <video id="video-player" poster="{% if video.thumbnail_url %}{{ video.thumbnail_url }}{% else %}{% static 'placeholder.jpg' %}{% endif %}" preload="metadata">
                    <!-- Video source will be added dynamically via JavaScript -->
                </video>
                
                <div class="video-overlays">
                    <div class="top-controls">
                        <div class="video-title">{{ video.title }}</div>
                        <div class="kronik-logo">
                            <div class="logo-icon">K</div>
                            <span>KRONIK</span>
                        </div>
                    </div>
                    
                    <div class="overlay-bottom-controls">
                        <div class="progress-container" id="progress-container">
                            <div class="buffer-bar" id="buffer-bar"></div>
                            <div class="progress-bar" id="progress-bar">
                                <div class="progress-handle"></div>
                            </div>
                        </div>
                        
                        <div class="controls-row">
                            <div class="left-controls">
                                <button class="control-button" id="play-pause-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                                    </svg>
                                </button>
                                
                                <div class="volume-container">
                                    <button class="control-button" id="volume-btn">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="currentColor"/>
                                            <path d="M19.07 4.93C20.91 6.77 22 9.27 22 12C22 14.73 20.91 17.23 19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            <path d="M15.54 8.46C16.47 9.39 17 10.62 17 12C17 13.38 16.47 14.61 15.54 15.54" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                    
                                    <div class="volume-slider">
                                        <div class="volume-bar" id="volume-bar">
                                            <div class="volume-level" id="volume-level"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="time-display">
                                    <span id="current-time">0:00</span>
                                    <span>/</span>
                                    <span id="duration">{{ video.duration|default:"0:00" }}</span>
                                </div>
                            </div>
                            
                            <div class="right-controls">
                                <button class="control-button" id="pip-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="2" y="4" width="20" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                                        <rect x="14" y="11" width="6" height="5" rx="1" fill="currentColor"/>
                                    </svg>
                                </button>
                                
                                <button class="control-button" id="fullscreen-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 8V4H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M4 16V20H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M20 8V4H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M20 16V20H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                
                                <button class="control-button" id="settings-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 8C9.79 8 8 9.79 8 12C8 14.21 9.79 16 12 16C14.21 16 16 14.21 16 12C16 9.79 14.21 8 12 8ZM12 14C10.9 14 10 13.1 10 12C10 10.9 10.9 10 12 10C13.1 10 14 10.9 14 12C14 13.1 13.1 14 12 14Z" fill="currentColor"/>
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.88 3.5L14.38 6.06C14.95 6.29 15.48 6.61 15.95 7L18.41 6.11L20.29 9.39L18.11 10.95C18.11 11.3 18.11 11.65 18.11 12C18.11 12.35 18.11 12.7 18.11 13.05L20.29 14.61L18.41 17.89L15.95 17C15.48 17.39 14.95 17.71 14.38 17.94L13.88 20.5H10.12L9.62 17.94C9.05 17.71 8.52 17.39 8.05 17L5.59 17.89L3.71 14.61L5.89 13.05C5.89 12.7 5.89 12.35 5.89 12C5.89 11.65 5.89 11.3 5.89 10.95L3.71 9.39L5.59 6.11L8.05 7C8.52 6.61 9.05 6.29 9.62 6.06L10.12 3.5H13.88ZM12 8C14.21 8 16 9.79 16 12C16 14.21 14.21 16 12 16C9.79 16 8 14.21 8 12C8 9.79 9.79 8 12 8Z" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="play-big-button visible" id="play-big-btn">
                    <div class="play-icon"></div>
                </div>
                
                <div class="loading-spinner" id="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <div class="settings-menu" id="settings-menu">
                <div class="settings-item" id="playback-speed-item">
                    <span>–°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è</span>
                    <span id="current-speed">1x</span>
                </div>
                
                <div class="playback-speed-options" id="playback-speed-options">
                    <div class="speed-option" data-speed="0.25">0.25x</div>
                    <div class="speed-option" data-speed="0.5">0.5x</div>
                    <div class="speed-option" data-speed="0.75">0.75x</div>
                    <div class="speed-option active" data-speed="1">1x</div>
                    <div class="speed-option" data-speed="1.25">1.25x</div>
                    <div class="speed-option" data-speed="1.5">1.5x</div>
                    <div class="speed-option" data-speed="1.75">1.75x</div>
                    <div class="speed-option" data-speed="2">2x</div>
                </div>
                
                <div class="settings-item" id="quality-item">
                    <span>–ö–∞—á–µ—Å—Ç–≤–æ</span>
                    <span id="current-quality">–∞–≤—Ç–æ</span>
                </div>
                
                <div class="quality-options" id="quality-options">
                    <div class="quality-option auto-quality active" data-quality="auto">
                        <span class="quality-label">–∞–≤—Ç–æ</span>
                        <span class="quality-badge">AI</span>
                    </div>
                    <!-- Quality options will be added dynamically via JavaScript -->
                </div>
                
                <div class="settings-item" id="loop-item">
                    <span>–ü–æ–≤—Ç–æ—Ä</span>
                    <span id="loop-status">–í—ã–∫–ª</span>
                </div>
            </div>

            <div class="quality-change-overlay" id="quality-change-overlay">
                <div class="quality-change-spinner"></div>
                <div class="quality-change-text">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞...</div>
            </div>
        </div>

        <div class="video-details">
            <h1>{{ video.title }}</h1>
            <div class="video-info-bar">
                <div class="views-info">{{ video.views_formatted }} ‚Ä¢ {{ video.upload_date_formatted|default:video.age }}</div>
                <div class="actions-bar">
                    <button class="action-button" id="likeButton"><span id="likeCount">{{ video.likes|default:"0" }}</span> <img src="/static/icons/like.svg" alt="–°—Ç—É–¥–∏—è" width="20" height="20"> –ù—Ä–∞–≤–∏—Ç—å—Å—è</button>
                    <button class="action-button" id="dislikeButton"><span id="dislikeCount">{{ video.dislikes|default:"0" }}</span><img src="/static/icons/dislike.svg" alt="–°—Ç—É–¥–∏—è" width="20" height="20"> –ù–µ –Ω—Ä–∞–≤–∏—Ç—å—Å—è</button>
                    <button class="action-button"><img src="/static/icons/share.svg" alt="–°—Ç—É–¥–∏—è" width="20" height="20"> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                </div>
            </div>
            
            <div class="channel-info">
                <div class="channel-avatar">{{ video.display_name|default:video.channel|first }}</div>
                <div class="channel-details">
                    <div class="channel-name">{{ video.display_name|default:video.channel }}</div>
                    <div class="subscribers">{{ video.subscribers|default:"0" }} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
                </div>
                <button class="subscribe-button">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
            </div>
            
            <div class="video-description">
                <p>{{ video.description|default:"–û–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç." }}</p>
            </div>
        </div>
                
        <div class="qa-section">
            <h2>–í–æ–ø—Ä–æ—Å—ã –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ</h2>
            <div class="comment-form" id="qa-form">
                <div class="user-avatar">{% if user.is_authenticated %}{% if user.profile.display_name %}{{ user.profile.display_name|first }}{% else %}{{ user.username|first }}{% endif %}{% else %}–ì{% endif %}</div>
                <input type="text" id="qa-input" placeholder="{% if user.is_authenticated %}–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...{% else %}–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å{% endif %}" {% if not user.is_authenticated %}disabled{% endif %}>
                <button id="qa-submit" class="qa-submit" {% if not user.is_authenticated %}disabled{% endif %}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            
            {% if not user.is_authenticated %}
            <div class="login-prompt">
                <p>–ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ <a href="{% url 'login' %}">–≤–æ–π—Ç–∏</a> –∏–ª–∏ <a href="{% url 'register' %}">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>.</p>
            </div>
            {% endif %}
            
            <div class="qa-list" id="qa-list">
                {% if comments %}
                    {% for comment in comments %}
                    <div class="qa-item" data-comment-id="{{ comment.id }}">
                        <div class="user-avatar {% if comment.user_id == video.user_id %}author-avatar{% endif %}">
                            {% if comment.avatar_url %}
                                <img src="{{ comment.avatar_url }}" alt="{{ comment.display_name }}">
                            {% else %}
                                {{ comment.display_name|first }}
                            {% endif %}
                        </div>
                        <div class="qa-content">
                            <div class="qa-author {% if comment.user_id == video.user_id %}is-author{% endif %}">
                                {{ comment.display_name }} 
                                {% if comment.user_id == video.user_id %}<span class="author-badge">–ê–≤—Ç–æ—Ä</span>{% endif %}
                            </div>
                            <div class="qa-text">{{ comment.text }}</div>
                            <div class="qa-meta">{{ comment.date|date:"d.m.Y" }}</div>
                            <div class="qa-actions">
                                <button class="qa-like" data-liked="false">üëç <span>{{ comment.likes|default:"0" }}</span></button>
                                <button class="qa-reply-btn" data-comment-id="{{ comment.id }}">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                            </div>
                            
                            <!-- Reply form (initially hidden) -->
                            <div class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;">
                                <div class="user-avatar">
                                    {% if user.is_authenticated %}
                                        {% if user_avatar_url %}
                                            <img src="{{ user_avatar_url }}" alt="{{ user.profile.display_name|default:user.username }}">
                                        {% else %}
                                            {% if user.profile.display_name %}{{ user.profile.display_name|first }}{% else %}{{ user.username|first }}{% endif %}
                                        {% endif %}
                                    {% else %}
                                            <img src="{% static 'default-avatar.png' %}" alt="–ì" width="40" height="40">
                                    {% endif %}
                                </div>
                                <input type="text" id="reply-input-{{ comment.id }}" placeholder="{% if user.is_authenticated %}–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å...{% else %}–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å{% endif %}" {% if not user.is_authenticated %}disabled{% endif %}>
                                <button class="reply-submit" data-comment-id="{{ comment.id }}" {% if not user.is_authenticated %}disabled{% endif %}>–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                                <button class="cancel-reply" data-comment-id="{{ comment.id }}">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                            
                            {% if comment.replies %}
                            <div class="qa-replies">
                                {% for reply in comment.replies %}
                                <div class="qa-reply">
                                    <div class="user-avatar {% if reply.user_id == video.user_id %}author-avatar{% endif %}">
                                        {% if reply.avatar_url %}
                                            <img src="{{ reply.avatar_url }}" alt="{{ reply.display_name }}">
                                        {% else %}
                                            {{ reply.display_name|first }}
                                        {% endif %}
                                    </div>
                                    <div class="qa-content">
                                        <div class="qa-author {% if reply.user_id == video.user_id %}is-author{% endif %}">
                                            {{ reply.display_name }}
                                            {% if reply.user_id == video.user_id %}<span class="author-badge">–ê–≤—Ç–æ—Ä</span>{% endif %}
                                        </div>
                                        <div class="qa-text">{{ reply.text }}</div>
                                        <div class="qa-meta">{{ reply.date|date:"d.m.Y" }}</div>
                                        <div class="qa-actions">
                                            <button class="qa-like">üëç <span>{{ reply.likes|default:"0" }}</span></button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-qa">
                        <div class="user-avatar">–ö</div>
                        <div class="qa-content">
                            <div class="qa-author">KRONIK</div>
                            <div class="qa-text">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>
                            <div class="qa-meta">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="related-videos">
        <h3>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –≤–∏–¥–µ–æ</h3>
        <div class="related-videos-list" id="related-videos-container">
            {% if recommended_videos %}
                {% for video in recommended_videos %}
                <div class="related-video-card" onclick="window.location.href='{{ video.url }}'">
                    <div class="related-thumbnail">
                        {% if video.thumbnail_url %}
                        <img src="{{ video.thumbnail_url }}" alt="{{ video.title }}" onerror="this.src='{% static 'placeholder.jpg' %}'">
                        {% else %}
                        <img src="{% static 'placeholder.jpg' %}" alt="{{ video.title }}">
                        {% endif %}
                    </div>
                    <div class="related-info">
                        <div class="related-title">{{ video.title }}</div>
                        <div class="related-channel">{{ video.display_name|default:video.channel }}</div>
                        <div class="related-stats">{{ video.views_formatted }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="padding: 20px; color: var(--gray-color); text-align: center;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/kronik-player.js' %}"></script>
<script src="{% static 'js/quality-change.js' %}"></script>
<script src="{% static 'js/qa-comments.js' %}"></script>
{% endblock %}