{% extends 'main/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ video.title }} - KRONIK{% endblock %}

{% block content %}
<div class="video-page-layout">
    <div class="video-content">
        <div class="video-container" data-video-id="{{ video.gcs_id }}" data-user-id="{{ video.user_id }}">
            <div class="video-wrapper">
                <video id="video-player" poster="{% if video.thumbnail_url %}{{ video.thumbnail_url }}{% else %}{% static 'placeholder.jpg' %}{% endif %}" preload="metadata">
                    <!-- Video source will be added dynamically via JavaScript -->
                </video>
                
                <div class="video-overlays">
                    <div class="top-controls">
                        <div class="video-title">{{ video.title }}</div>
                        <div class="kronik-logo">
                            <div class="logo-icon">K</div>
                            <span>KRONIK</span>
                        </div>
                    </div>
                    
                    <div class="overlay-bottom-controls">
                        <div class="progress-container" id="progress-container">
                            <div class="buffer-bar" id="buffer-bar"></div>
                            <div class="progress-bar" id="progress-bar">
                                <div class="progress-handle"></div>
                            </div>
                        </div>
                        
                        <div class="controls-row">
                            <div class="left-controls">
                                <button class="control-button" id="play-pause-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                                    </svg>
                                </button>
                                
                                <div class="volume-container">
                                    <button class="control-button" id="volume-btn">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="currentColor"/>
                                            <path d="M19.07 4.93C20.91 6.77 22 9.27 22 12C22 14.73 20.91 17.23 19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            <path d="M15.54 8.46C16.47 9.39 17 10.62 17 12C17 13.38 16.47 14.61 15.54 15.54" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                    
                                    <div class="volume-slider">
                                        <div class="volume-bar" id="volume-bar">
                                            <div class="volume-level" id="volume-level"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="time-display">
                                    <span id="current-time">0:00</span>
                                    <span>/</span>
                                    <span id="duration">{{ video.duration|default:"0:00" }}</span>
                                </div>
                            </div>
                            
                            <div class="right-controls">
                                <button class="control-button" id="pip-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="2" y="4" width="20" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                                        <rect x="14" y="11" width="6" height="5" rx="1" fill="currentColor"/>
                                    </svg>
                                </button>
                                
                                <button class="control-button" id="fullscreen-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 8V4H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M4 16V20H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M20 8V4H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M20 16V20H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                
                                <button class="control-button" id="settings-btn">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 8C9.79 8 8 9.79 8 12C8 14.21 9.79 16 12 16C14.21 16 16 14.21 16 12C16 9.79 14.21 8 12 8ZM12 14C10.9 14 10 13.1 10 12C10 10.9 10.9 10 12 10C13.1 10 14 10.9 14 12C14 13.1 13.1 14 12 14Z" fill="currentColor"/>
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.88 3.5L14.38 6.06C14.95 6.29 15.48 6.61 15.95 7L18.41 6.11L20.29 9.39L18.11 10.95C18.11 11.3 18.11 11.65 18.11 12C18.11 12.35 18.11 12.7 18.11 13.05L20.29 14.61L18.41 17.89L15.95 17C15.48 17.39 14.95 17.71 14.38 17.94L13.88 20.5H10.12L9.62 17.94C9.05 17.71 8.52 17.39 8.05 17L5.59 17.89L3.71 14.61L5.89 13.05C5.89 12.7 5.89 12.35 5.89 12C5.89 11.65 5.89 11.3 5.89 10.95L3.71 9.39L5.59 6.11L8.05 7C8.52 6.61 9.05 6.29 9.62 6.06L10.12 3.5H13.88ZM12 8C14.21 8 16 9.79 16 12C16 14.21 14.21 16 12 16C9.79 16 8 14.21 8 12C8 9.79 9.79 8 12 8Z" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="play-big-button visible" id="play-big-btn">
                    <div class="play-icon"></div>
                </div>
                
                <div class="loading-spinner" id="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <div class="settings-menu" id="settings-menu">
                <div class="settings-item" id="playback-speed-item">
                    <span>Скорость воспроизведения</span>
                    <span id="current-speed">1x</span>
                </div>
                
                <div class="playback-speed-options" id="playback-speed-options">
                    <div class="speed-option" data-speed="0.25">0.25x</div>
                    <div class="speed-option" data-speed="0.5">0.5x</div>
                    <div class="speed-option" data-speed="0.75">0.75x</div>
                    <div class="speed-option active" data-speed="1">1x</div>
                    <div class="speed-option" data-speed="1.25">1.25x</div>
                    <div class="speed-option" data-speed="1.5">1.5x</div>
                    <div class="speed-option" data-speed="1.75">1.75x</div>
                    <div class="speed-option" data-speed="2">2x</div>
                </div>
                
                <div class="settings-item" id="quality-item">
                    <span>Качество</span>
                    <span id="current-quality">авто</span>
                </div>
                
                <div class="quality-options" id="quality-options">
                    <div class="quality-option" data-quality="auto">авто</div>
                    <!-- Quality options will be added dynamically via JavaScript -->
                </div>
                
                <div class="settings-item" id="loop-item">
                    <span>Повтор</span>
                    <span id="loop-status">Выкл</span>
                </div>
            </div>

            <div class="quality-change-overlay" id="quality-change-overlay">
                <div class="quality-change-spinner"></div>
                <div class="quality-change-text">Изменение качества...</div>
            </div>
        </div>

        <div class="video-details">
            <h1>{{ video.title }}</h1>
            <div class="video-info-bar">
                <div class="views-info">{{ video.views_formatted }} • {{ video.upload_date_formatted|default:video.age }}</div>
                <div class="actions-bar">
                    <button class="action-button" id="likeButton"><span id="likeCount">{{ video.likes|default:"0" }}</span> <img src="/static/icons/like.svg" alt="Студия" width="20" height="20"> Нравиться</button>
                    <button class="action-button" id="dislikeButton"><span id="dislikeCount">{{ video.dislikes|default:"0" }}</span><img src="/static/icons/dislike.svg" alt="Студия" width="20" height="20"> Не нравиться</button>
                    <button class="action-button"><img src="/static/icons/share.svg" alt="Студия" width="20" height="20"> Поделиться</button>
                </div>
            </div>
            
            <div class="channel-info">
                <div class="channel-avatar">{{ video.display_name|default:video.channel|first }}</div>
                <div class="channel-details">
                    <div class="channel-name">{{ video.display_name|default:video.channel }}</div>
                    <div class="subscribers">{{ video.subscribers|default:"0" }} подписчиков</div>
                </div>
                <button class="subscribe-button">Подписаться</button>
            </div>
            
            <div class="video-description">
                <p>{{ video.description|default:"Описание видео отсутствует." }}</p>
            </div>
        </div>
                
        <div class="comments-section">
            <h2>Комментарии</h2>
            <div class="comment-form">
                <div class="user-avatar">{% if user.is_authenticated %}{{ user.username|first }}{% else %}Г{% endif %}</div>
                <input type="text" placeholder="{% if user.is_authenticated %}Добавить комментарий...{% else %}Войдите, чтобы комментировать{% endif %}" {% if not user.is_authenticated %}disabled{% endif %}>
            </div>
            
            <div class="comments-list">
                {% if comments %}
                    {% for comment in comments %}
                    <div class="comment">
                        <div class="comment-avatar">{{ comment.display_name|first }}</div>
                        <div class="comment-content">
                            <div class="comment-author">{{ comment.display_name }}</div>
                            <div class="comment-text">{{ comment.text }}</div>
                            <div class="comment-meta">{{ comment.date|date:"d.m.Y" }}</div>
                            <div class="comment-actions">
                                <button class="comment-like">👍 <span>{{ comment.likes|default:"0" }}</span></button>
                                <button class="comment-dislike">👎</button>
                                <button class="comment-reply">Ответить</button>
                            </div>
                            
                            {% if comment.replies %}
                            <div class="comment-replies">
                                {% for reply in comment.replies %}
                                <div class="reply">
                                    <div class="comment-avatar">{{ reply.display_name|first }}</div>
                                    <div class="comment-content">
                                        <div class="comment-author">{{ reply.display_name }}</div>
                                        <div class="comment-text">{{ reply.text }}</div>
                                        <div class="comment-meta">{{ reply.date|date:"d.m.Y" }}</div>
                                        <div class="comment-actions">
                                            <button class="comment-like">👍 <span>{{ reply.likes|default:"0" }}</span></button>
                                            <button class="comment-dislike">👎</button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="comment">
                        <div class="comment-avatar">К</div>
                        <div class="comment-content">
                            <div class="comment-author">KRONIK</div>
                            <div class="comment-text">Этот ролик пока никто не комментировал. Будьте первым!</div>
                            <div class="comment-meta">Только что</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="related-videos">
        <h3>Рекомендуемые видео</h3>
        <div class="related-videos-list" id="related-videos-container">
            {% if recommended_videos %}
                {% for video in recommended_videos %}
                <div class="related-video-card" onclick="window.location.href='{{ video.url }}'">
                    <div class="related-thumbnail">
                        {% if video.thumbnail_url %}
                        <img src="{{ video.thumbnail_url }}" alt="{{ video.title }}" onerror="this.src='{% static 'placeholder.jpg' %}'">
                        {% else %}
                        <img src="{% static 'placeholder.jpg' %}" alt="{{ video.title }}">
                        {% endif %}
                    </div>
                    <div class="related-info">
                        <div class="related-title">{{ video.title }}</div>
                        <div class="related-channel">{{ video.display_name|default:video.channel }}</div>
                        <div class="related-stats">{{ video.views_formatted }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="padding: 20px; color: var(--gray-color); text-align: center;">Рекомендации загружаются...</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get player elements
        const videoPlayer = document.getElementById('video-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playBigBtn = document.getElementById('play-big-btn');
        const volumeBtn = document.getElementById('volume-btn');
        const volumeBar = document.getElementById('volume-bar');
        const volumeLevel = document.getElementById('volume-level');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const bufferBar = document.getElementById('buffer-bar');
        const currentTimeDisplay = document.getElementById('current-time');
        const durationDisplay = document.getElementById('duration');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const pipBtn = document.getElementById('pip-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const playbackSpeedItem = document.getElementById('playback-speed-item');
        const playbackSpeedOptions = document.getElementById('playback-speed-options');
        const qualityItem = document.getElementById('quality-item');
        const qualityOptions = document.getElementById('quality-options');
        const loopItem = document.getElementById('loop-item');
        const loopStatus = document.getElementById('loop-status');
        const currentSpeed = document.getElementById('current-speed');
        const currentQuality = document.getElementById('current-quality');
        const speedOptions = document.querySelectorAll('.speed-option');
        const loadingSpinner = document.getElementById('loading-spinner');
        const videoContainer = document.querySelector('.video-container');
        
        // Early exit if the video player doesn't exist
        if (!videoPlayer) return;
        
        // Get video id and user id from the container data attributes
        const videoId = videoContainer.getAttribute('data-video-id');
        const userId = videoContainer.getAttribute('data-user-id');
        
        // Variables for tracking available qualities
        let availableQualities = [];
        let currentQualitySelection = 'auto';
        
        // Show loading spinner
        loadingSpinner.classList.add('visible');
        
        // Format time function
        function formatTime(seconds) {
            if (isNaN(seconds)) return "0:00";
            
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        // Update play/pause icon function
        function updatePlayPauseIcon(isPlaying) {
            if (isPlaying) {
                playPauseBtn.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="6" y="4" width="4" height="16" rx="1" fill="currentColor"/>
                        <rect x="14" y="4" width="4" height="16" rx="1" fill="currentColor"/>
                    </svg>
                `;
                playBigBtn.innerHTML = `
                    <div class="pause-icon">
                        <div class="pause-bar"></div>
                        <div class="pause-bar"></div>
                    </div>
                `;
                playBigBtn.classList.remove('visible');
            } else {
                playPauseBtn.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                    </svg>
                `;
                playBigBtn.innerHTML = `<div class="play-icon"></div>`;
                playBigBtn.classList.add('visible');
            }
        }
        
        // Toggle play/pause function
        function togglePlay() {
            if (videoPlayer.paused) {
                videoPlayer.play();
            } else {
                videoPlayer.pause();
            }
        }
        
        // Update volume icon function
        function updateVolumeIcon() {
            if (videoPlayer.muted || videoPlayer.volume === 0) {
                volumeBtn.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="currentColor"/>
                        <path d="M23 9L17 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M17 9L23 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                `;
            } else if (videoPlayer.volume < 0.5) {
                volumeBtn.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="currentColor"/>
                        <path d="M15.54 8.46C16.47 9.39 17 10.62 17 12C17 13.38 16.47 14.61 15.54 15.54" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                `;
            } else {
                volumeBtn.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 5L6 9H2V15H6L11 19V5Z" fill="currentColor"/>
                        <path d="M15.54 8.46C16.47 9.39 17 10.62 17 12C17 13.38 16.47 14.61 15.54 15.54" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M19.07 4.93C20.91 6.77 22 9.27 22 12C22 14.73 20.91 17.23 19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                `;
            }
        }
        
        // Show error message function
        function showErrorMessage(message) {
            // Hide loading spinner
            loadingSpinner.classList.remove('visible');
            
            // Create error message element
            const errorElement = document.createElement('div');
            errorElement.className = 'video-error-message';
            errorElement.innerHTML = `
                <div class="error-icon">⚠️</div>
                <div class="error-text">${message}</div>
                <button class="error-retry-btn">Повторить</button>
            `;
            
            // Add retry functionality
            const retryButton = errorElement.querySelector('.error-retry-btn');
            if (retryButton) {
                retryButton.addEventListener('click', function() {
                    errorElement.remove();
                    loadingSpinner.classList.add('visible');
                    fetchVideoUrl(videoId, userId);
                });
            }
            
            // Add error message to video container
            const videoWrapper = document.querySelector('.video-wrapper');
            if (videoWrapper) {
                videoWrapper.appendChild(errorElement);
            }
        }
        
        // Fetch video URL asynchronously with quality selection
        function fetchVideoUrl(videoId, userId, quality = 'auto') {
            // Error handling to make sure videoId and userId are valid
            if (!videoId || !userId) {
                console.error('Missing videoId or userId');
                showErrorMessage('Ошибка загрузки: информация о видео отсутствует');
                return;
            }
            
            // Construct API URL with user_id parameter and quality
            const apiUrl = `/api/get-video-url/${videoId}/?user_id=${encodeURIComponent(userId)}&quality=${quality}`;
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.url) {
                        // Store available qualities
                        availableQualities = data.available_qualities || [];
                        currentQualitySelection = data.quality || 'auto';
                        
                        // Initialize quality selector
                        initializeQualityOptions(availableQualities);
                        
                        // Update current quality display
                        if (currentQuality) {
                            currentQuality.textContent = currentQualitySelection;
                        }
                        
                        // Set video source and start loading
                        const source = document.createElement('source');
                        source.src = data.url;
                        source.type = 'video/mp4';
                        videoPlayer.appendChild(source);
                        videoPlayer.load();
                        
                        // Preload metadata
                        videoPlayer.setAttribute('preload', 'metadata');
                    } else {
                        console.error('Error loading video:', data.error || 'Unknown error');
                        showErrorMessage('Не удалось загрузить видео. Пожалуйста, попробуйте позже.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching video URL:', error);
                    showErrorMessage('Ошибка при загрузке видео. Проверьте соединение с интернетом.');
                });
        }
        
        // ===== Event listeners =====
        
        // Metadata loaded - hide spinner and update duration
        videoPlayer.addEventListener('loadedmetadata', function() {
            durationDisplay.textContent = formatTime(videoPlayer.duration);
            loadingSpinner.classList.remove('visible');
        });
        
        // Time update - update progress bar and current time
        videoPlayer.addEventListener('timeupdate', function() {
            currentTimeDisplay.textContent = formatTime(videoPlayer.currentTime);
            const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
            progressBar.style.width = `${progress}%`;
        });
        
        // Video progress (buffering) handler
        videoPlayer.addEventListener('progress', function() {
            if (videoPlayer.buffered.length > 0) {
                const bufferedEnd = videoPlayer.buffered.end(videoPlayer.buffered.length - 1);
                const duration = videoPlayer.duration;
                if (duration > 0) {
                    const bufferedPercent = (bufferedEnd / duration) * 100;
                    bufferBar.style.width = `${bufferedPercent}%`;
                }
            }
        });
        
        // Video waiting handler - show spinner
        videoPlayer.addEventListener('waiting', function() {
            loadingSpinner.classList.add('visible');
        });
        
        // Video playing handler - hide spinner and update play icon
        videoPlayer.addEventListener('playing', function() {
            loadingSpinner.classList.remove('visible');
            updatePlayPauseIcon(true);
        });
        
        // Video paused handler - update play icon
        videoPlayer.addEventListener('pause', function() {
            updatePlayPauseIcon(false);
        });
        
        // Video ended handler - show play icon
        videoPlayer.addEventListener('ended', function() {
            updatePlayPauseIcon(false);
        });
        
        // Error handler - show error message
        videoPlayer.addEventListener('error', function() {
            let errorMessage = 'Ошибка при загрузке видео';
            
            if (videoPlayer.error) {
                switch (videoPlayer.error.code) {
                    case MediaError.MEDIA_ERR_ABORTED:
                        errorMessage = 'Воспроизведение прервано пользователем';
                        break;
                    case MediaError.MEDIA_ERR_NETWORK:
                        errorMessage = 'Сетевая ошибка при загрузке видео';
                        break;
                    case MediaError.MEDIA_ERR_DECODE:
                        errorMessage = 'Ошибка декодирования видео';
                        break;
                    case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        errorMessage = 'Формат видео не поддерживается';
                        break;
                }
            }
            
            showErrorMessage(errorMessage);
        });
        
        // Play/pause button handler
        playPauseBtn.addEventListener('click', togglePlay);
        
        // Big play button handler
        playBigBtn.addEventListener('click', function() {
            togglePlay();
        });
        
        // Video player click handler
        videoPlayer.addEventListener('click', function(e) {
            // Only toggle if not clicking on controls
            if (e.target === videoPlayer) {
                togglePlay();
            }
        });
        
        // Progress bar click handler
        progressContainer.addEventListener('click', function(e) {
            if (!videoPlayer.duration) return; // Don't do anything if duration is not available
            
            const rect = progressContainer.getBoundingClientRect();
            const position = (e.clientX - rect.left) / rect.width;
            videoPlayer.currentTime = position * videoPlayer.duration;
        });
        
        // Volume bar click handler
        volumeBar.addEventListener('click', function(e) {
            const rect = volumeBar.getBoundingClientRect();
            const position = (e.clientX - rect.left) / rect.width;
            videoPlayer.volume = Math.max(0, Math.min(1, position));
            volumeLevel.style.width = `${videoPlayer.volume * 100}%`;
            
            // Unmute if volume is set manually
            if (videoPlayer.muted && videoPlayer.volume > 0) {
                videoPlayer.muted = false;
            }
            
            updateVolumeIcon();
        });
        
        // Volume button click handler (mute/unmute)
        volumeBtn.addEventListener('click', function() {
            videoPlayer.muted = !videoPlayer.muted;
            if (videoPlayer.muted) {
                volumeLevel.style.width = '0';
            } else {
                volumeLevel.style.width = `${videoPlayer.volume * 100}%`;
            }
            updateVolumeIcon();
        });
        
        // Fullscreen button click handler
        fullscreenBtn.addEventListener('click', function() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                videoContainer.requestFullscreen().catch(err => {
                    console.error(`Ошибка при переходе в полноэкранный режим: ${err.message}`);
                });
            }
        });
        
        // PiP button click handler
        pipBtn.addEventListener('click', function() {
            if (document.pictureInPictureElement) {
                document.exitPictureInPicture().catch(err => {
                    console.error(`Ошибка при выходе из режима картинка-в-картинке: ${err.message}`);
                });
            } else if (document.pictureInPictureEnabled) {
                videoPlayer.requestPictureInPicture().catch(err => {
                    console.error(`Ошибка при входе в режим картинка-в-картинке: ${err.message}`);
                });
            }
        });
        
        // Settings button click handler
        settingsBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            settingsMenu.classList.toggle('active');
        });
        
        // Close settings menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) {
                settingsMenu.classList.remove('active');
                playbackSpeedOptions.classList.remove('active');
                qualityOptions.classList.remove('active');
            }
        });
        
        // Playback speed menu handler
        playbackSpeedItem.addEventListener('click', function() {
            playbackSpeedOptions.classList.toggle('active');
            qualityOptions.classList.remove('active');
        });
        
        // Playback speed options handlers
        speedOptions.forEach(option => {
            option.addEventListener('click', function() {
                const speed = parseFloat(option.getAttribute('data-speed'));
                videoPlayer.playbackRate = speed;
                currentSpeed.textContent = `${speed}x`;
                
                speedOptions.forEach(opt => {
                    opt.classList.remove('active');
                });
                option.classList.add('active');
            });
        });
        
        // Quality menu handler
        qualityItem.addEventListener('click', function() {
            qualityOptions.classList.toggle('active');
            playbackSpeedOptions.classList.remove('active');
        });
        
        // Loop toggle handler
        loopItem.addEventListener('click', function() {
            videoPlayer.loop = !videoPlayer.loop;
            loopStatus.textContent = videoPlayer.loop ? 'Вкл' : 'Выкл';
        });
        
        // Keyboard controls
        document.addEventListener('keydown', function(e) {
            // Skip if focus is on an input element
            if (document.activeElement.tagName === 'INPUT') return;
            
            switch (e.key) {
                case ' ':
                case 'k':
                    togglePlay();
                    e.preventDefault();
                    break;
                case 'ArrowLeft':
                    videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 5);
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    videoPlayer.currentTime = Math.min(videoPlayer.duration || 0, videoPlayer.currentTime + 5);
                    e.preventDefault();
                    break;
                case 'f':
                    fullscreenBtn.click();
                    e.preventDefault();
                    break;
                case 'm':
                    videoPlayer.muted = !videoPlayer.muted;
                    if (videoPlayer.muted) {
                        volumeLevel.style.width = '0';
                    } else {
                        volumeLevel.style.width = `${videoPlayer.volume * 100}%`;
                    }
                    updateVolumeIcon();
                    e.preventDefault();
                    break;
                case '0':
                case '1':
                case '2':
                case '3':
                case '4':
                case '5':
                case '6':
                case '7':
                case '8':
                case '9':
                    if (videoPlayer.duration) {
                        const percent = parseInt(e.key) * 10;
                        videoPlayer.currentTime = videoPlayer.duration * (percent / 100);
                        e.preventDefault();
                    }
                    break;
            }
        });
        
        // Initialize UI states
        updateVolumeIcon();
        volumeLevel.style.width = `${videoPlayer.volume * 100}%`;
        
        // Initialize async video loading
        // Start video loading immediately (don't wait for any other resources)
        if (videoId && userId) {
            // Initiate video loading immediately with auto quality
            fetchVideoUrl(videoId, userId, 'auto');
        } else {
            showErrorMessage('Ошибка: Не найден идентификатор видео');
        }
        
        // Track view after 5 seconds of playback
        let viewTracked = false;
        videoPlayer.addEventListener('timeupdate', function() {
            if (!viewTracked && videoPlayer.currentTime > 5) {
                viewTracked = true;
                console.log('View tracked');
                // In a real app, you would make an AJAX request to track the view
            }
        });
    });
</script>

<script>
    /**
     * Quality Selection Functions
     */
    
    // Function to fetch video URL for specific quality
    function fetchVideoQuality(userId, videoId, quality) {
        return fetch(`/api/get-video-url/${videoId}/?user_id=${encodeURIComponent(userId)}&quality=${quality}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                return response.json();
            });
    }
    
    // Function to show quality change overlay
    function showQualityChangeOverlay() {
        const overlay = document.getElementById('quality-change-overlay');
        if (overlay) {
            overlay.classList.add('visible');
        }
    }
    
    // Function to hide quality change overlay
    function hideQualityChangeOverlay() {
        const overlay = document.getElementById('quality-change-overlay');
        if (overlay) {
            overlay.classList.remove('visible');
        }
    }
    
    // Function to change video quality
    function changeVideoQuality(quality) {
        const videoPlayer = document.getElementById('video-player');
        const videoContainer = document.querySelector('.video-container');
        
        if (!videoPlayer || !videoContainer) return;
        
        // Get video ID and user ID
        const videoId = videoContainer.getAttribute('data-video-id');
        const userId = videoContainer.getAttribute('data-user-id');
        
        if (!videoId || !userId) {
            console.error('Missing video ID or user ID');
            return;
        }
        
        // Save current playback state
        const currentTime = videoPlayer.currentTime;
        const wasPlaying = !videoPlayer.paused;
        
        // Pause video and show loading overlay
        videoPlayer.pause();
        showQualityChangeOverlay();
        
        // Fetch video URL for the selected quality
        fetchVideoQuality(userId, videoId, quality)
            .then(data => {
                if (data.success && data.url) {
                    // Update current quality display
                    const currentQualityDisplay = document.getElementById('current-quality');
                    if (currentQualityDisplay) {
                        currentQualityDisplay.textContent = data.quality;
                    }
                    
                    // Update active class on quality options
                    const qualityOptions = document.querySelectorAll('.quality-option');
                    qualityOptions.forEach(option => {
                        if (option.getAttribute('data-quality') === data.quality ||
                            (option.getAttribute('data-quality') === 'auto' && data.quality === 'auto')) {
                            option.classList.add('active');
                        } else {
                            option.classList.remove('active');
                        }
                    });
                    
                    // Remember current time
                    const currentTime = videoPlayer.currentTime;
                    
                    // Create new source elements
                    const source = document.createElement('source');
                    source.src = data.url;
                    source.type = 'video/mp4';
                    
                    // Remove existing sources
                    while (videoPlayer.firstChild) {
                        videoPlayer.removeChild(videoPlayer.firstChild);
                    }
                    
                    // Add new source
                    videoPlayer.appendChild(source);
                    
                    // Wait for video to load metadata
                    videoPlayer.addEventListener('loadedmetadata', function onMetadataLoaded() {
                        // Set time to where we left off
                        videoPlayer.currentTime = currentTime;
                        
                        // Resume playback if it was playing
                        if (wasPlaying) {
                            videoPlayer.play()
                                .then(() => {
                                    hideQualityChangeOverlay();
                                })
                                .catch(error => {
                                    console.error('Error resuming playback:', error);
                                    hideQualityChangeOverlay();
                                });
                        } else {
                            hideQualityChangeOverlay();
                        }
                        
                        // Remove this event listener
                        videoPlayer.removeEventListener('loadedmetadata', onMetadataLoaded);
                    });
                    
                    // Handle loading error
                    videoPlayer.addEventListener('error', function onLoadError() {
                        console.error('Error loading video at quality:', data.quality);
                        hideQualityChangeOverlay();
                        videoPlayer.removeEventListener('error', onLoadError);
                    });
                    
                    // Load the video
                    videoPlayer.load();
                } else {
                    console.error('Failed to get video URL:', data.error || 'Unknown error');
                    hideQualityChangeOverlay();
                }
            })
            .catch(error => {
                console.error('Error fetching video URL:', error);
                hideQualityChangeOverlay();
            });
    }
    
    // Function to initialize quality options
    function initializeQualityOptions(availableQualities) {
        const qualityOptions = document.getElementById('quality-options');
        const currentQualityDisplay = document.getElementById('current-quality');
        
        if (!qualityOptions || !availableQualities) return;
        
        // Clear existing options except 'auto'
        const autoOption = qualityOptions.querySelector('.quality-option[data-quality="auto"]');
        qualityOptions.innerHTML = '';
        
        if (autoOption) {
            qualityOptions.appendChild(autoOption);
        } else {
            // Create auto option if it doesn't exist
            const autoDiv = document.createElement('div');
            autoDiv.className = 'quality-option auto-quality';
            autoDiv.setAttribute('data-quality', 'auto');
            autoDiv.innerHTML = `
                <span class="quality-label">Авто</span>
                <span class="quality-badge">AI</span>
            `;
            qualityOptions.appendChild(autoDiv);
        }
        
        // Define quality info
        const qualityInfo = {
            '240p': 'Низкое, экономит трафик',
            '360p': 'Экономия трафика',
            '480p': 'Стандартное',
            '720p': 'HD',
            '1080p': 'Full HD',
            'original': 'Оригинал'
        };
        
        // Add available qualities
        availableQualities.forEach(quality => {
            if (quality === 'auto') return; // Skip auto, already added
            
            const qualityDiv = document.createElement('div');
            qualityDiv.className = 'quality-option';
            qualityDiv.setAttribute('data-quality', quality);
            
            // Set quality label and info
            qualityDiv.innerHTML = `
                <span class="quality-label">${quality}</span>
                <span class="quality-info">${qualityInfo[quality] || ''}</span>
            `;
            
            qualityOptions.appendChild(qualityDiv);
        });
        
        // Set current quality display
        if (currentQualityDisplay) {
            const activeQuality = availableQualities[0] || 'original';
            currentQualityDisplay.textContent = activeQuality;
        }
        
        // Add event listeners to quality options
        document.querySelectorAll('.quality-option').forEach(option => {
            option.addEventListener('click', function() {
                const quality = this.getAttribute('data-quality');
                changeVideoQuality(quality);
                
                // Hide quality options
                qualityOptions.classList.remove('active');
            });
        });
    }
</script>
{% endblock %}